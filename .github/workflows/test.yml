name: WiFi Professional - Automated Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTCæ—¶é—´00:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html pytest-xdist
    
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        python run_tests.py --ci
      continue-on-error: false
    
    - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ°Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: ğŸ“„ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          test_reports/
          .coverage
        retention-days: 30
    
    - name: ğŸ“ˆ å‘å¸ƒæµ‹è¯•ç»“æœ
      if: always()
      uses: EnricoMi/publish-unit-test-result-action/composite@v2
      with:
        files: test_reports/junit.xml
        check_name: Test Results (${{ matrix.os }} - Python ${{ matrix.python-version }})

  lint:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…Lintå·¥å…·
      run: |
        pip install pylint black flake8 mypy
    
    - name: ğŸ” è¿è¡ŒPylint
      run: |
        pylint core/ wifi_modules/ --exit-zero --output-format=text | tee pylint-report.txt
      continue-on-error: true
    
    - name: ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰
      run: |
        black --check core/ wifi_modules/ || true
      continue-on-error: true
    
    - name: ğŸ“‹ è¿è¡ŒFlake8
      run: |
        flake8 core/ wifi_modules/ --max-line-length=120 --exit-zero
      continue-on-error: true
    
    - name: ğŸ“¤ ä¸Šä¼ LintæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports
        path: pylint-report.txt
        retention-days: 30

  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ”’ è¿è¡ŒBanditå®‰å…¨æ‰«æ
      run: |
        pip install bandit
        bandit -r core/ wifi_modules/ -f json -o bandit-report.json || true
      continue-on-error: true
    
    - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: bandit-report.json
        retention-days: 30

  performance:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-benchmark
    
    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        python run_tests.py --marker performance
      continue-on-error: true

  badge:
    name: æ›´æ–°å¾½ç« 
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ… åˆ›å»ºæµ‹è¯•é€šè¿‡å¾½ç« 
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: your-gist-id-here
        filename: wifi-professional-tests.json
        label: Tests
        message: Passing
        color: green
      continue-on-error: true
