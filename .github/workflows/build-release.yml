name: Build Multi-Platform Release

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # å½“æŽ¨é€æ ‡ç­¾ï¼ˆå¦‚ v1.7.2ï¼‰æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ==================== Windows æž„å»º ====================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ðŸ”¨ æž„å»º Windows EXE
      run: |
        pyinstaller wifi_professional.spec
    
    - name: ðŸ“Š æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        if (Test-Path "dist\WiFiä¸“ä¸šå·¥å…·.exe") {
          Write-Host "âœ… Windows æž„å»ºæˆåŠŸ"
          $size = (Get-Item "dist\WiFiä¸“ä¸šå·¥å…·.exe").Length / 1MB
          Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Windows æž„å»ºå¤±è´¥"
          exit 1
        }
    
    - name: ðŸ“¤ ä¸Šä¼  Windows æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: WiFiä¸“ä¸šå·¥å…·-Windows
        path: dist/WiFiä¸“ä¸šå·¥å…·.exe
        retention-days: 30

  # ==================== macOS æž„å»º ====================
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller
    
    - name: ðŸŽ¨ åˆ›å»ºå›¾æ ‡ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
      run: |
        if [ ! -f "wifi_icon.icns" ]; then
          if [ -f "wifi_icon.png" ]; then
            echo "ä»Ž PNG åˆ›å»º ICNS..."
            mkdir -p wifi_icon.iconset
            sips -z 16 16     wifi_icon.png --out wifi_icon.iconset/icon_16x16.png
            sips -z 32 32     wifi_icon.png --out wifi_icon.iconset/icon_16x16@2x.png
            sips -z 32 32     wifi_icon.png --out wifi_icon.iconset/icon_32x32.png
            sips -z 64 64     wifi_icon.png --out wifi_icon.iconset/icon_32x32@2x.png
            sips -z 128 128   wifi_icon.png --out wifi_icon.iconset/icon_128x128.png
            sips -z 256 256   wifi_icon.png --out wifi_icon.iconset/icon_128x128@2x.png
            sips -z 256 256   wifi_icon.png --out wifi_icon.iconset/icon_256x256.png
            sips -z 512 512   wifi_icon.png --out wifi_icon.iconset/icon_256x256@2x.png
            sips -z 512 512   wifi_icon.png --out wifi_icon.iconset/icon_512x512.png
            sips -z 1024 1024 wifi_icon.png --out wifi_icon.iconset/icon_512x512@2x.png
            iconutil -c icns wifi_icon.iconset
            rm -rf wifi_icon.iconset
            echo "âœ… ICNS å›¾æ ‡åˆ›å»ºæˆåŠŸ"
          fi
        fi
    
    - name: ðŸ”¨ æž„å»º macOS APP
      run: |
        pyinstaller build_macos.spec
    
    - name: ðŸ“Š æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        if [ -d "dist/WiFiä¸“ä¸šå·¥å…·.app" ]; then
          echo "âœ… macOS æž„å»ºæˆåŠŸ"
          du -sh dist/WiFiä¸“ä¸šå·¥å…·.app
        else
          echo "âŒ macOS æž„å»ºå¤±è´¥"
          exit 1
        fi
    
    - name: ðŸ“¦ åŽ‹ç¼© APP
      run: |
        cd dist
        zip -r WiFiä¸“ä¸šå·¥å…·-macOS.zip WiFiä¸“ä¸šå·¥å…·.app
        cd ..
    
    - name: ðŸ’¿ åˆ›å»º DMG é•œåƒ
      run: |
        hdiutil create -volname "WiFiä¸“ä¸šå·¥å…·" \
          -srcfolder "dist/WiFiä¸“ä¸šå·¥å…·.app" \
          -ov -format UDZO \
          "dist/WiFiä¸“ä¸šå·¥å…·-macOS.dmg"
        echo "âœ… DMG é•œåƒåˆ›å»ºæˆåŠŸ"
    
    - name: ðŸ“¤ ä¸Šä¼  macOS ZIP
      uses: actions/upload-artifact@v4
      with:
        name: WiFiä¸“ä¸šå·¥å…·-macOS-ZIP
        path: dist/WiFiä¸“ä¸šå·¥å…·-macOS.zip
        retention-days: 30
    
    - name: ðŸ“¤ ä¸Šä¼  macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: WiFiä¸“ä¸šå·¥å…·-macOS-DMG
        path: dist/WiFiä¸“ä¸šå·¥å…·-macOS.dmg
        retention-days: 30

  # ==================== Linux æž„å»º ====================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk
    
    - name: ðŸ“¦ å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: ðŸ”¨ æž„å»º Linux å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller --onefile \
          --windowed \
          --name "wifi-professional" \
          --add-data "config.json:." \
          wifi_professional.py
    
    - name: ðŸ“Š æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        if [ -f "dist/wifi-professional" ]; then
          echo "âœ… Linux æž„å»ºæˆåŠŸ"
          ls -lh dist/wifi-professional
          chmod +x dist/wifi-professional
        else
          echo "âŒ Linux æž„å»ºå¤±è´¥"
          exit 1
        fi
    
    - name: ðŸ“¤ ä¸Šä¼  Linux æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: WiFiä¸“ä¸šå·¥å…·-Linux
        path: dist/wifi-professional
        retention-days: 30

  # ==================== åˆ›å»º Release ====================
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        
        # Windows
        if [ -f "artifacts/WiFiä¸“ä¸šå·¥å…·-Windows/WiFiä¸“ä¸šå·¥å…·.exe" ]; then
          cp "artifacts/WiFiä¸“ä¸šå·¥å…·-Windows/WiFiä¸“ä¸šå·¥å…·.exe" "release/"
          cd release
          zip WiFiä¸“ä¸šå·¥å…·-Windows-${{ github.ref_name }}.zip WiFiä¸“ä¸šå·¥å…·.exe
          cd ..
        fi
        
        # macOS
        if [ -f "artifacts/WiFiä¸“ä¸šå·¥å…·-macOS-ZIP/WiFiä¸“ä¸šå·¥å…·-macOS.zip" ]; then
          cp "artifacts/WiFiä¸“ä¸šå·¥å…·-macOS-ZIP/WiFiä¸“ä¸šå·¥å…·-macOS.zip" "release/WiFiä¸“ä¸šå·¥å…·-macOS-${{ github.ref_name }}.zip"
        fi
        
        if [ -f "artifacts/WiFiä¸“ä¸šå·¥å…·-macOS-DMG/WiFiä¸“ä¸šå·¥å…·-macOS.dmg" ]; then
          cp "artifacts/WiFiä¸“ä¸šå·¥å…·-macOS-DMG/WiFiä¸“ä¸šå·¥å…·-macOS.dmg" "release/WiFiä¸“ä¸šå·¥å…·-macOS-${{ github.ref_name }}.dmg"
        fi
        
        # Linux
        if [ -f "artifacts/WiFiä¸“ä¸šå·¥å…·-Linux/wifi-professional" ]; then
          cp "artifacts/WiFiä¸“ä¸šå·¥å…·-Linux/wifi-professional" "release/"
          cd release
          tar -czf WiFiä¸“ä¸šå·¥å…·-Linux-${{ github.ref_name }}.tar.gz wifi-professional
          cd ..
        fi
        
        ls -lh release/
    
    - name: ðŸ“‹ ç”Ÿæˆ Release Notes
      run: |
        cat > release/RELEASE_NOTES.md << 'EOF'
        # WiFiä¸“ä¸šå·¥å…· ${{ github.ref_name }}
        
        ## ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        ### Windows ç”¨æˆ·
        - ä¸‹è½½ `WiFiä¸“ä¸šå·¥å…·-Windows-${{ github.ref_name }}.zip`
        - è§£åŽ‹åŽè¿è¡Œ `WiFiä¸“ä¸šå·¥å…·.exe`
        - éœ€è¦ç®¡ç†å‘˜æƒé™
        
        ### macOS ç”¨æˆ·
        - **æŽ¨è**: ä¸‹è½½ `WiFiä¸“ä¸šå·¥å…·-macOS-${{ github.ref_name }}.dmg`
        - æˆ–ä¸‹è½½ `WiFiä¸“ä¸šå·¥å…·-macOS-${{ github.ref_name }}.zip`
        - é¦–æ¬¡è¿è¡Œï¼šå³é”® â†’ æ‰“å¼€
        - éœ€è¦æŽˆäºˆä½ç½®æœåŠ¡æƒé™
        
        ### Linux ç”¨æˆ·
        - ä¸‹è½½ `WiFiä¸“ä¸šå·¥å…·-Linux-${{ github.ref_name }}.tar.gz`
        - è§£åŽ‹åŽæ·»åŠ æ‰§è¡Œæƒé™ï¼š`chmod +x wifi-professional`
        - è¿è¡Œï¼š`./wifi-professional`
        
        ## âœ¨ åŠŸèƒ½ç‰¹æ€§
        - âœ… WiFi ç½‘ç»œæ‰«æä¸Žåˆ†æž
        - âœ… ä¿¡é“åˆ†æžä¸Žä¼˜åŒ–å»ºè®®
        - âœ… å®žæ—¶ä¿¡å·ç›‘æŽ§
        - âœ… çƒ­åŠ›å›¾ç”Ÿæˆ
        - âœ… AP éƒ¨ç½²è§„åˆ’
        - âœ… å®‰å…¨æ£€æµ‹ä¸Žè¯„ä¼°
        - âœ… ä¼ä¸šçº§ PDF æŠ¥å‘Š
        - âœ… WiFi 6/6E/7 æ”¯æŒ
        
        ## ðŸ“– æ–‡æ¡£
        - Windows: å‚é˜… README.md
        - macOS: å‚é˜… README_MACOS.md
        - å¿«é€Ÿå…¥é—¨: MACOS_QUICKSTART.md
        
        ## ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆã€‚
        
        ---
        **ç‰ˆæœ¬**: ${{ github.ref_name }}  
        **æž„å»ºæ—¥æœŸ**: $(date +%Y-%m-%d)  
        **å¼€å‘è€…**: NL@China_SZ
        EOF
    
    - name: ðŸš€ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== æž„å»ºæ‘˜è¦ ====================
  build-summary:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š ç”Ÿæˆæž„å»ºæ‘˜è¦
      run: |
        echo "## ðŸ—ï¸ æž„å»ºç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| å¹³å° | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| Windows | ${{ needs.build-windows.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS | ${{ needs.build-macos.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linux | ${{ needs.build-linux.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
